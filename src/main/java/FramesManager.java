import javax.xml.crypto.Data;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;

public class FramesManager {

    private static final int data_size = 100;
    ArrayList<Frame> framesList;
    public ArrayList<String> binFrameList;

    public void createFramesList(byte[] data, int windowSize){
        framesList = new ArrayList<>();

        byte type;
        int num;
        Frame frame;

        int n = (int) Math.ceil((double) data.length / data_size); // nb de frames
        byte[] data_chunk;
        int src_pos = 0;

        for (int i = 0; i < n; i++) {
            type = 'I'; // test
            num = i % windowSize;

            data_chunk = new byte[data_size];

            if (data.length - (i * data_size) < data_size) {// last data chunk
                data_chunk = new byte[data.length - (i * data_size)];
                System.arraycopy(data, src_pos, data_chunk, 0, data.length - (i * data_size));
            } else {
                System.arraycopy(data, src_pos, data_chunk, 0, data_size);
            }

            framesList.add(new Frame(type, num, data_chunk));
            src_pos += data_size;

            binFrameList = new ArrayList<>();

            //add flag and convert frames to binary
            for (Frame f : framesList) {
                binFrameList.add(f.getFlag() + DataManipulation.bitStuffing(f.toBin()) + f.getFlag());
            }
        }
    }

    public ArrayList<String> getBinFrameList() {
        return binFrameList;
    }

    public String getFrameToSend(Frame fm){
        return fm.getFlag() + fm.toBin() + fm.getFlag();
    }

    public Frame getFrameConnectionConfirmation(Frame fm) {

        // go-back-N request
        if(fm.getNum() == 0){
            //send RR0 -> is waiting for the first frame
            return new Frame("A",0);

        } else { //not supported
            //send an end of communication
            return new Frame("F", 0);
        }
    }

    // TODO : handleInput..

    public String handleInput (String input) {
        input = input.substring(8, input.length() - 8);    // without flags
        return DataManipulation.bitUnStuffing(input);    // remove bit stuffing

    }

    public Frame getFrameAck(Frame fm) {

        //send aknowledgement
        return new Frame("A", (fm.getNum() + 1)% 7); //window size
    }

    /**
     * Vérifie si le frame reçue n'est pas erroné
     * @param binFrame reçu sous format binaire (string)
     * @return : boolean
     */
    public boolean containsError(String binFrame) {
        boolean isWrong = false;
        if (!Checksum.xor_div(binFrame).equals("0")) {
            isWrong = true;
        }
        return isWrong;
    }

    //Test
    public static void main(String args[]){
        String testBin = "0111111001001001000000000101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100000010100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001000001010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100000101001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000000101001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000000101001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010000010100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001000001010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000001010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000001010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100000101001010100011001010111001101111110";

        FramesManager fmTest = new FramesManager();

//        fmTest.getFrame(testBin);


    }


}
