import javax.xml.crypto.Data;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;

public class FramesManager {

    private static final int data_size = 100;  // 1000 byte = 1Kb  // TODO data frame size ou frame size au complet?
    ArrayList<Frame> framesList;
    public ArrayList<String> binFrameList;

    public void createFramesList(byte[] data, int windowSize){
        framesList = new ArrayList<Frame>() {
        };

        byte type;
        int num;
        Frame frame;

        int n = (int) Math.ceil((double) data.length / data_size); // nb de frame TODO: revoir..
        byte[] data_chunk;
        int src_pos = 0;

        for (int i = 0; i < n; i++) {
            type = 'I'; // test
            num = i % windowSize;


            data_chunk = new byte[data_size];
            if (data.length - (i * data_size) < data_size) // last data chunk
                System.arraycopy(data, src_pos, data_chunk, 0, data.length - (i * data_size));
            else
                System.arraycopy(data, src_pos, data_chunk, 0, data_size);


            framesList.add(new Frame(type, num, data_chunk));
            src_pos += data_size;

            binFrameList = new ArrayList<>();

            //add flag and convert frames to binary
            for (Frame f : framesList) {
                binFrameList.add(f.getFlag() + DataManipulation.bitStuffing(f.toBin()) + f.getFlag());
            }
        }
    }

    public ArrayList<String> getBinFrameList() {
        return binFrameList;
    }

    /**
     * Return a Frame when get a binary String that represent a frame
     * @param binFrame
     * @return
     */
    public Frame getFrame(String binFrame){

        //TODO unstuffing ?? 

        //first get substring for different part
        String flag1 = binFrame.substring(0,8);
        String flag2 = binFrame.substring(binFrame.length() - 8);

        binFrame = binFrame.substring(8, binFrame.length() - 8);    // without flags
        binFrame = DataManipulation.bitUnStuffing(binFrame);    // remove bit stuffing

        byte type = DataManipulation.binToByte(binFrame.substring(8,16));
        int num = DataManipulation.binToInt(binFrame.substring(16,24));

        //data
        String dataString = binFrame.substring(24, binFrame.length() -8 );
        int dataSize = dataString.length();
        byte[] data = DataManipulation.binToBytes(dataString, dataSize);

        String CRC = binFrame.substring(24, 40);

        return new Frame(flag1, type, num, data, CRC, flag2);
    }

    //Test
    public static void main(String args[]){
        String testBin = "0111111001001001000000000101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100000010100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001000001010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100000101001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000000101001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000000101001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010000010100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001000001010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000001010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000001010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100101010001100101011100110111010000100000011101000110010101110011011101000010000000110001001100100011000100110010010101000110010101110011011101000010000001110100011001010111001101110100001000000011000100110010001100010011001001010100011001010111001101110100001000000111010001100101011100110111010000100000001100010011001000110001001100100000101001010100011001010111001101111110";

        FramesManager fmTest = new FramesManager();

        fmTest.getFrame(testBin);


    }



}
